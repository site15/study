# üß† Deadlocks –≤ RabbitMQ

**Deadlock** ‚Äî —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ **–¥–≤–µ –∏–ª–∏ –±–æ–ª–µ–µ –æ–ø–µ—Ä–∞—Ü–∏–π –∂–¥—É—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –∏ –Ω–∏ –æ–¥–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è**.

–í RabbitMQ —ç—Ç–æ –Ω–µ –ø—Ä—è–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π SQL-deadlock (row-level lock), –Ω–æ –µ—Å—Ç—å –∞–Ω–∞–ª–æ–≥–∏:

---

## üîπ –ö–∞–∫ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç

1. **Consumer –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è**:

   * –±–µ—Ä–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (`prefetch=1`)
   * –¥–æ–ª–≥–æ –µ–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
   * –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `ack`
2. **Producer –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è**:

   * –æ—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç–µ—Ç
   * RabbitMQ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç **memory / disk limit**
3. **–î—Ä—É–≥–∏–µ consumers –∂–¥—É—Ç**:

   * –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
   * —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
4. –í –∏—Ç–æ–≥–µ: —Å–∏—Å—Ç–µ–º–∞ **–∑–∞–º–µ—Ä–ª–∞**, –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è.

---

## üîπ –¢–∏–ø–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä (Node.js)

```ts
channel.prefetch(1);

channel.consume('tasks', async (msg) => {
  // –¥–æ–ª–≥–∏–π –ø—Ä–æ—Ü–µ—Å—Å
  await heavyTask(msg.content);
  channel.ack(msg);
});
```

* –ï—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç 1000 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 1 –º–∏–Ω—É—Ç—É
* Consumer –¥–æ–ª–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí –æ—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç–µ—Ç ‚Üí RabbitMQ –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

---

## üîπ –ö–∞–∫ —Ä–µ—à–∞—é—Ç

1. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π prefetch**:

   ```ts
   channel.prefetch(10); // –º–∞–∫—Å–∏–º—É–º 10 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
   ```
2. **Ack –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏**
3. **–î–µ–ª–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ**:

   * –≤–º–µ—Å—Ç–æ 1 —Ç—è–∂–µ–ª–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ ‚Üí –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª—ë–≥–∫–∏—Ö
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:

   * `rabbitmqctl list_queues` ‚Üí —Å–º–æ—Ç—Ä–µ—Ç—å –¥–ª–∏–Ω—É –æ—á–µ—Ä–µ–¥–µ–π
   * `rabbitmqctl list_connections` ‚Üí –∫—Ç–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª

---

# üß† Backpressure –≤ RabbitMQ

**Backpressure** ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º **—Å–∏–≥–Ω–∞–ª–∞ –¥–ª—è Producer‚Äô–æ–≤**, —á—Ç–æ –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞ –∏ –Ω—É–∂–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è.

---

## üîπ –ö–∞–∫ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç

1. Producer —à–ª—ë—Ç —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ
2. Queue –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Üí memory limit
3. RabbitMQ:

   * —Å—Ç–∞–≤–∏—Ç **TCP flow control**
   * –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Producer‚Äô—É (write –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)

> Producer ¬´–∑–∞–º–∏—Ä–∞–µ—Ç¬ª, –ø–æ–∫–∞ Broker –Ω–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç –º–µ—Å—Ç–æ

---

## üîπ –ü—Ä–∏–∑–Ω–∞–∫–∏

* `channel.sendToQueue()` **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç false**
* Producer –Ω–∞—á–∏–Ω–∞–µ—Ç –∂–¥–∞—Ç—å (`drain` event)
* –û—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç–µ—Ç ‚Üí –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç

---

## üîπ –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å

```ts
const ok = channel.sendToQueue(queue, msg);
if (!ok) {
  channel.once('drain', () => {
    // –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É
  });
}
```

* –≠—Ç–æ —Å–∏–≥–Ω–∞–ª **‚Äú–ø–æ–¥–æ–∂–¥–∏, –±—Ä–æ–∫–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω‚Äù**
* –¢–∞–∫ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **flow control –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

---

## üîπ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω

1. **–ü–æ—Å—Ç–∞–≤—å prefetch –Ω–∞ consumer** ‚Äî –Ω–µ –±–µ—Ä–∏ –±–æ–ª—å—à–µ, —á–µ–º –º–æ–∂–µ—à—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
2. **–ü—Ä–æ–≤–µ—Ä—è–π return value `sendToQueue`** ‚Äî –∑–∞–º–µ–¥–ª—è–π Producer
3. **DLX + TTL** ‚Äî —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –∑–∞–±–∏–≤–∞—é—Ç –æ—á–µ—Ä–µ–¥—å
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ / disk / message count**
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–π consumers –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ** ‚Äî —É–º–µ–Ω—å—à–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É

---

# ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

* **prefetch=0** ‚Äî Consumer –±–µ—Ä—ë—Ç –≤—Å—ë —Å—Ä–∞–∑—É ‚Üí –¥–æ–ª–≥–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
* **Producer –Ω–µ —Å–ª—É—à–∞–µ—Ç drain** ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ—Ä—è—é—Ç—Å—è / memory spikes
* **–î–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å ack=false** ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—é –æ—á–µ—Ä–µ–¥—å
* **–ù–µ—Ç DLX** ‚Äî backlog ‚Üí Out of Memory ‚Üí –ø–∞–¥–µ–Ω–∏–µ –±—Ä–æ–∫–µ—Ä–∞

---

# üé§ –ó–æ–ª–æ—Ç—ã–µ —Ñ—Ä–∞–∑—ã –Ω–∞ —Å–æ–±–µ—Å–µ

> Deadlock –≤ RabbitMQ ‚Äî —ç—Ç–æ —á–∞—â–µ **queue blockage –∏–∑-–∑–∞ –¥–æ–ª–≥–∏—Ö –∑–∞–¥–∞—á –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ prefetch**, –∞ –Ω–µ classic row-level lock.

> Backpressure ‚Äî —ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª –¥–ª—è Producer‚Äô–∞: ¬´–æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å, —è –Ω–µ —É—Å–ø–µ–≤–∞—é –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ¬ª.

> –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –≤—Å–µ–≥–¥–∞ –∫–æ–º–±–∏–Ω–∏—Ä—É—é prefetch, ack –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –∏ DLX –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.

---

# üß† –ö–æ—Ä–æ—Ç–∫–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞

| –ü—Ä–æ–±–ª–µ–º–∞        | –°–∏–º–ø—Ç–æ–º                       | –†–µ—à–µ–Ω–∏–µ                                                     |
| --------------- | ----------------------------- | ----------------------------------------------------------- |
| Deadlock        | –æ—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç—ë—Ç, consumer –∂–¥—ë—Ç | —É–º–µ–Ω—å—à–∏—Ç—å prefetch, –¥–µ–ª–∏—Ç—å –∑–∞–¥–∞—á–∏, ack –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è     |
| Backpressure    | sendToQueue ‚Üí false           | —Å–ª—É—à–∞—Ç—å drain, –∑–∞–º–µ–¥–ª—è—Ç—å Producer, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å consumers |
| Memory overflow | broker OOM                    | DLX, TTL, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π                 |
