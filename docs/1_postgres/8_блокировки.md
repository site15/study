# üîê –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ PostgreSQL ‚Äî –æ–±—â–µ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ

–í Postgres –µ—Å—Ç—å **–¥–≤–∞ –±–æ–ª—å—à–∏—Ö –º–∏—Ä–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**:

1. **MVCC** ‚Äî —á–∏—Ç–∞—Ç–µ–ª–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–∏—Å–∞—Ç–µ–ª–µ–π
2. **Row-level locks** ‚Äî –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ *—è–≤–Ω–æ* –∑–∞—â–∏—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫–∏

üëâ `SELECT FOR UPDATE` ‚Äî —ç—Ç–æ **—Å—Ç—Ä–æ–∫–æ–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞**, –∞ –Ω–µ —Ç–∞–±–ª–∏—á–Ω–∞—è.

---

# üß† –ó–∞—á–µ–º –≤–æ–æ–±—â–µ `SELECT FOR UPDATE`

–ü—Ä–æ—Å—Ç–∞—è –º—ã—Å–ª—å:

> ¬´–Ø —Å–µ–π—á–∞—Å —á–∏—Ç–∞—é —Å—Ç—Ä–æ–∫—É –∏ —Å–æ–±–∏—Ä–∞—é—Å—å –µ—ë –º–µ–Ω—è—Ç—å ‚Äî
> –ø—É—Å—Ç—å –Ω–∏–∫—Ç–æ –¥—Ä—É–≥–æ–π –µ—ë –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç, –ø–æ–∫–∞ —è –Ω–µ –∑–∞–∫–æ–Ω—á—É¬ª.

---

## –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å (—Å–æ–±–µ—Å ‚Ññ1)

**–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥–µ**

```sql
BEGIN;

SELECT *
FROM "Products"
WHERE id = 42
FOR UPDATE;

-- –ø—Ä–æ–≤–µ—Ä–∏–ª–∏, —á—Ç–æ stock > 0

UPDATE "Products"
SET stock = stock - 1
WHERE id = 42;

COMMIT;
```

üîí –ü–æ–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å:

* –Ω–∏–∫—Ç–æ –Ω–µ —Å–º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
* –¥—Ä—É–≥–∏–µ `FOR UPDATE` –±—É–¥—É—Ç –∂–¥–∞—Ç—å

---

# üß± –ö–∞–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç–∞–≤–∏—Ç FOR UPDATE

`SELECT ‚Ä¶ FOR UPDATE` —Å—Ç–∞–≤–∏—Ç:

* **RowExclusiveLock** –Ω–∞ —Å—Ç—Ä–æ–∫–∏
* –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±—ã—á–Ω—ã–π `SELECT`
* –±–ª–æ–∫–∏—Ä—É–µ—Ç:

  * `UPDATE`
  * `DELETE`
  * –¥—Ä—É–≥–æ–π `SELECT FOR UPDATE`

---

## –ß—Ç–æ –±—É–¥–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏

| –ó–∞–ø—Ä–æ—Å              | –ü–æ–≤–µ–¥–µ–Ω–∏–µ  |
| ------------------- | ---------- |
| `SELECT`            | ‚úî —Ä–∞–±–æ—Ç–∞–µ—Ç |
| `SELECT FOR UPDATE` | ‚è≥ –∂–¥—ë—Ç     |
| `UPDATE`            | ‚è≥ –∂–¥—ë—Ç     |
| `DELETE`            | ‚è≥ –∂–¥—ë—Ç     |

---

# üîÑ FOR UPDATE vs FOR SHARE

### `FOR UPDATE`

* —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø
* —è –±—É–¥—É –º–µ–Ω—è—Ç—å —Å—Ç—Ä–æ–∫—É

### `FOR SHARE`

* —è —Ö–æ—á—É –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –µ—ë **–Ω–µ –∏–∑–º–µ–Ω—è—Ç**
* –Ω–æ —Å–∞–º –º–µ–Ω—è—Ç—å –Ω–µ –±—É–¥—É

```sql
SELECT * FROM "Orders" WHERE id = 1 FOR SHARE;
```

---

# üß© –ü–æ–ª–µ–∑–Ω—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏

## SKIP LOCKED ‚Äî –∑–æ–ª–æ—Ç–æ –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π

```sql
SELECT *
FROM "Jobs"
WHERE status = 'new'
FOR UPDATE SKIP LOCKED
LIMIT 1;
```

üëâ –∫–∞–∂–¥—ã–π –≤–æ—Ä–∫–µ—Ä –±–µ—Ä—ë—Ç **—Å–≤–æ—é** –∑–∞–¥–∞—á—É
üëâ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏ –¥–µ–¥–ª–æ–∫–æ–≤

---

## NOWAIT ‚Äî fail fast

```sql
SELECT *
FROM "Accounts"
WHERE id = 1
FOR UPDATE NOWAIT;
```

–ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞:

```text
ERROR: could not obtain lock on row
```

---

# ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (—á–∞—Å—Ç–æ –ª–æ–≤—è—Ç –Ω–∞ —Å–æ–±–µ—Å–µ)

## ‚ùå SELECT ‚Üí –ø–æ—Ç–æ–º UPDATE (–±–µ–∑ FOR UPDATE)

```sql
SELECT stock FROM Products WHERE id = 42;
UPDATE Products SET stock = stock - 1 WHERE id = 42;
```

üëâ **race condition**
üëâ –¥–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ –º–æ–≥—É—Ç —Å–ø–∏—Å–∞—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç–æ–≤–∞—Ä

---

## ‚ùå –î–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å FOR UPDATE

* –±–ª–æ–∫–∏—Ä—É—é—Ç —Å–∏—Å—Ç–µ–º—É
* —Ä–∞—Å—Ç—è—Ç –æ—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞–Ω–∏—è
* –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –¥–µ–¥–ª–æ–∫–∞–º

---

# ‚ò†Ô∏è Deadlock (–æ—á–µ–Ω—å –ª—é–±—è—Ç)

```text
T1: FOR UPDATE row A ‚Üí –∂–¥—ë—Ç B
T2: FOR UPDATE row B ‚Üí –∂–¥—ë—Ç A
```

Postgres:

* —Å–∞–º –¥–µ—Ç–µ–∫—Ç–∏—Ç
* **—É–±–∏–≤–∞–µ—Ç –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é**

```text
ERROR: deadlock detected
```

üëâ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Äî **retry**

---

# üß† –°–≤—è–∑—å —Å —É—Ä–æ–≤–Ω—è–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏

| –£—Ä–æ–≤–µ–Ω—å         | FOR UPDATE –Ω—É–∂–µ–Ω?                  |
| --------------- | ---------------------------------- |
| Read Committed  | ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ                      |
| Repeatable Read | ‚úÖ —á–∞—Å—Ç–æ                            |
| Serializable    | –∏–Ω–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–µ–Ω, –Ω–æ –±—ã–≤–∞–µ—Ç –ø–æ–ª–µ–∑–µ–Ω |

---

# üõ† –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –±–∞–∑–µ

```sql
SELECT *
FROM pg_locks;
```

```sql
SELECT pid, query, wait_event_type, wait_event
FROM pg_stat_activity
WHERE wait_event IS NOT NULL;
```

---

# üé§ –ó–æ–ª–æ—Ç—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Å–æ–±–µ—Å–∞

> SELECT FOR UPDATE ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º —è–≤–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫, –∞ –Ω–µ –∑–∞–º–µ–Ω–∞ –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

> –î–ª—è –æ—á–µ—Ä–µ–¥–µ–π —è –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é FOR UPDATE SKIP LOCKED.

---

# üß† –ö–æ—Ä–æ—Ç–∫–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞

| –ù—É–∂–Ω–æ            | –ò—Å–ø–æ–ª—å–∑—É–π           |
| ---------------- | ------------------- |
| –∑–∞—â–∏—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫—É  | FOR UPDATE          |
| read-only –∑–∞—â–∏—Ç–∞ | FOR SHARE           |
| –æ—á–µ—Ä–µ–¥—å          | SKIP LOCKED         |
| fail fast        | NOWAIT              |
| –∏–∑–±–µ–∂–∞—Ç—å race    | FOR UPDATE + UPDATE |