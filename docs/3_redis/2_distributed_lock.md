# üîê –ó–∞—á–µ–º –≤–æ–æ–±—â–µ distributed lock

–ù—É–∂–µ–Ω, –∫–æ–≥–¥–∞:

* –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
* –æ–¥–∏–Ω –æ–±—â–∏–π —Ä–µ—Å—É—Ä—Å
* **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω**

### –†–µ–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã

* —Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥
* –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞
* cron-–∑–∞–¥–∞—á–∏
* cache warmup
* –º–∏–≥—Ä–∞—Ü–∏–∏ / batch job

---

# üß† –ì–ª–∞–≤–Ω–∞—è –∏–¥–µ—è Redis-lock

> **–ê—Ç–æ–º–∞—Ä–Ω–æ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –∫–ª—é—á —Å TTL**
> –∏ **–æ—Å–≤–æ–±–æ–¥–∏—Ç—å –µ–≥–æ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É**

---

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ë–ê–ó–û–í–´–ô LOCK (must know)

## –ó–∞—Ö–≤–∞—Ç lock‚Äô–∞

```redis
SET lock:order:42 "uuid-123" NX PX 10000
```

### –ß—Ç–æ –∑–¥–µ—Å—å –≤–∞–∂–Ω–æ

* `NX` ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç
* `PX 10000` ‚Äî TTL (10 —Å–µ–∫—É–Ω–¥)
* `"uuid-123"` ‚Äî **—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–ª–∞–¥–µ–ª—å—Ü–∞**

üëâ –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–æ—Å—å `OK` ‚Äî lock –ø–æ–ª—É—á–µ–Ω
üëâ –µ—Å–ª–∏ `null` ‚Äî lock –∑–∞–Ω—è—Ç

---

## –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ lock‚Äô–∞ (–ö–†–ò–¢–ò–ß–ù–û!)

‚ùå **–ù–ï –¢–ê–ö**

```redis
DEL lock:order:42
```

–ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è:

* TTL –∏—Å—Ç—ë–∫
* lock –∑–∞—Ö–≤–∞—Ç–∏–ª –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å
* —Ç—ã —É–¥–∞–ª–∏—à—å **—á—É–∂–æ–π** lock

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî —á–µ—Ä–µ–∑ Lua

```redis
EVAL "
if redis.call('GET', KEYS[1]) == ARGV[1] then
  return redis.call('DEL', KEYS[1])
else
  return 0
end
" 1 lock:order:42 uuid-123
```

üëâ —É–¥–∞–ª—è–µ—Ç lock **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –≤–ª–∞–¥–µ–ª–µ—Ü**

---

# üß™ –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä (–ø—Å–µ–≤–¥–æ–∫–æ–¥)

```ts
const lockKey = 'lock:order:42';
const lockValue = uuid();
const ttl = 10000;

const acquired = await redis.set(
  lockKey,
  lockValue,
  'NX',
  'PX',
  ttl
);

if (!acquired) {
  throw new Error('Resource is locked');
}

try {
  // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
  await processOrder();
} finally {
  await redis.eval(UNLOCK_LUA, 1, lockKey, lockValue);
}
```

---

# ‚ö†Ô∏è –°–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ (–ª–æ–≤—É—à–∫–∏ –Ω–∞ —Å–æ–±–µ—Å–µ)

## ‚ùå –ù–µ—Ç TTL

‚Üí –≤–µ—á–Ω—ã–π lock
‚Üí –ø—Ä–æ–¥–∞–∫—à–µ–Ω –ª–µ–∂–∏—Ç

---

## ‚ùå –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ value

```text
"locked"
```

‚Üí –ª—é–±–æ–π –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å

---

## ‚ùå DEL –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏

‚Üí race condition

---

## ‚ùå –î–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è > TTL

‚Üí lock –∏—Å—Ç—ë–∫
‚Üí –≤—Ç–æ—Ä–æ–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞—à—ë–ª
‚Üí **–¥–≤–æ–π–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**

üëâ —Ä–µ—à–µ–Ω–∏–µ:

* —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å TTL
* –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å lock
* –¥–µ–ª–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏

---

# üîÅ –ü—Ä–æ–¥–ª–µ–Ω–∏–µ lock‚Äô–∞ (watchdog)

–ü–∞—Ç—Ç–µ—Ä–Ω:

* –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä
* –µ—Å–ª–∏ lock –≤—Å—ë –µ—â—ë —Ç–≤–æ–π ‚Üí `PEXPIRE`

```redis
if GET lock == my_uuid:
  PEXPIRE lock 10000
```

üëâ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Redlock-–∫–ª–∏–µ–Ω—Ç

---

# üß† –ê —á—Ç–æ —Ç–∞–∫–æ–µ Redlock?

**Redlock** ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è Redis:

* –Ω–µ—Å–∫–æ–ª—å–∫–æ Redis-–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
* lock —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–æ–≥–ª–∞—Å–∏–ª–æ—Å—å

üìå **–í–∞–∂–Ω–æ –¥–ª—è —Å–æ–±–µ—Å–∞:**

> Redlock –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö –∫ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.
> –í 90% —Å–∏—Å—Ç–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ Redis —Å TTL.

---

# üèó –ö–æ–≥–¥–∞ Redis-lock ‚Äî –ø–ª–æ—Ö–∞—è –∏–¥–µ—è

‚ùå —Ñ–∏–Ω–∞–Ω—Å—ã
‚ùå —Å—Ç—Ä–æ–≥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å
‚ùå —Å–ª–æ–∂–Ω—ã–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

üëâ –ª—É—á—à–µ:

* PostgreSQL `SELECT FOR UPDATE`
* advisory locks
* –æ—á–µ—Ä–µ–¥—å

---

# üé§ –ó–æ–ª–æ—Ç—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Å–æ–±–µ—Å–∞

> Distributed lock –≤ Redis —Å—Ç—Ä–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ `SET NX PX` –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–∏ unlock.

> TTL ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ, –∏–Ω–∞—á–µ lock —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–µ—á–Ω—ã–º.

> Redis-lock ‚Äî —ç—Ç–æ best-effort –º–µ—Ö–∞–Ω–∏–∑–º, –∞ –Ω–µ –∑–∞–º–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

---

# üß† –ö–æ—Ä–æ—Ç–∫–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞

| –®–∞–≥             | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| --------------- | ----------- |
| SET             | NX + TTL    |
| Value           | —É–Ω–∏–∫–∞–ª—å–Ω—ã–π  |
| UNLOCK          | Lua + check |
| TTL             | –≤—Å–µ–≥–¥–∞      |
| Retry           | –¥–∞          |
| –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å | –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ  |
